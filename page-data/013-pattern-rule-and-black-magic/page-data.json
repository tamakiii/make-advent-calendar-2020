{"componentChunkName":"component---src-templates-markdown-js","path":"/013-pattern-rule-and-black-magic","result":{"data":{"markdownRemark":{"html":"<h1>パターンルールと黒魔術</h1>\n<p>パターンルールは便利な反面、Makefile を複雑化しやすいです。</p>\n<p>例えば、docker-compose のインターフェースとして、よく使うサブコマンドを、黒魔術の誘惑によってこのように書きたくなることもあります。\n<code class=\"language-text\">&lt;サービス名&gt;/&lt;操作&gt;</code> といった規則の糖衣構文的なルールです。</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-makefile line-numbers\"><code class=\"language-makefile\"><span class=\"token symbol\">database/%</span><span class=\"token punctuation\">:</span>\n  make docker-compose/<span class=\"token variable\">$(@F)</span> SERVICE<span class=\"token operator\">=</span><span class=\"token variable\">$(@D)</span>\n\n<span class=\"token symbol\">docker-compose/%</span><span class=\"token punctuation\">:</span>\n  docker-compose <span class=\"token variable\">$(@F)</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>SERVICE<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>TARGET<span class=\"token punctuation\">:</span><span class=\"token punctuation\">-</span>production<span class=\"token punctuation\">-</span>pseudo<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> password\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mysqldata<span class=\"token punctuation\">:</span>/var/lib/mysql\n\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  mysqldata<span class=\"token punctuation\">:</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">:</span>8.0.22 AS production<span class=\"token punctuation\">-</span>pseudo\n\n<span class=\"token comment\"># --</span>\n\n<span class=\"token keyword\">FROM</span> production<span class=\"token punctuation\">-</span>pseudo AS development\n\n<span class=\"token comment\"># https://forums.mysql.com/read.php?12,426247,432315#msg-432315</span>\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>install<span class=\"token punctuation\">-</span>recommends \\\n      man \\\n      man<span class=\"token punctuation\">-</span>db \\\n      manpages \\\n      &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get clean &amp;&amp; \\\n    rm <span class=\"token punctuation\">-</span>rf /var/lib/apt/lists/*</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>しかしこういった黒魔術はメンテナンス性を下げますし、統一的に書けるという幻想は大抵すぐに瓦解します。</p>\n<p>本当に自動化したいルールを重視し、糖衣構文的なルールを用意するにしても使用頻度が高いものに絞り、できるだけ素朴に書くのが、Makefile をメンテナンスして育てる秘訣ではないかと思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-makefile line-numbers\"><code class=\"language-makefile\"><span class=\"token builtin\">.PHONY</span><span class=\"token punctuation\">:</span> help setup setup-dev build up logs down migrate clean\n\nTARGET <span class=\"token operator\">:=</span> production-pseudo\n\n<span class=\"token symbol\">help</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token operator\">@</span>cat <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">firstword</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>MAKEFILE_LIST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token symbol\">setup</span><span class=\"token punctuation\">:</span> \\\n\t.env\n\n<span class=\"token symbol\">setup-dev</span><span class=\"token punctuation\">:</span> \\\n\t<span class=\"token variable\">$</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">eval</span> TARGET <span class=\"token operator\">:=</span> development<span class=\"token punctuation\">)</span> \\\n\tsetup\n\n<span class=\"token symbol\">build</span><span class=\"token punctuation\">:</span> docker-compose.yml\n\tdocker-compose build\n\n<span class=\"token symbol\">up</span><span class=\"token punctuation\">:</span>\n\tdocker-compose up -d\n\n<span class=\"token symbol\">logs</span><span class=\"token punctuation\">:</span>\n\tdocker-compose logs -f\n\n<span class=\"token symbol\">down</span><span class=\"token punctuation\">:</span>\n\tdocker-compose down\n\n<span class=\"token symbol\">migrate</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\"># ...</span>\n\n<span class=\"token symbol\">.env</span><span class=\"token punctuation\">:</span>\n\techo <span class=\"token string\">\"TARGET=$(TARGET)\"</span> > <span class=\"token variable\">$@</span>\n\n<span class=\"token symbol\">clean</span><span class=\"token punctuation\">:</span>\n\tdocker-compose down -v\n\trm -rf .env</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>README などで補足するのもよいと思います。使用頻度が高いものを Makefile に昇格させるようにすれば、それがメンテナンス性を考慮する機会になるはずです。</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-markdown line-numbers\"><code class=\"language-markdown\"><span class=\"token title important\"><span class=\"token punctuation\">##</span> How to use</span>\n~<span class=\"token strike\"><span class=\"token punctuation\">~~</span><span class=\"token content\">sh\nmake -f docker.mk setup-dev\nmake -f docker.mk build up\nmake -f docker.mk down\n</span><span class=\"token punctuation\">~~</span></span>~\n\n<span class=\"token title important\"><span class=\"token punctuation\">##</span> Basic usages of docker-compose</span>\n~<span class=\"token strike\"><span class=\"token punctuation\">~~</span><span class=\"token content\">sh\ndocker-compose ps [service]\ndocker-compose exec &lt;service> &lt;command>\ndocker-compose run --rm &lt;service> &lt;command>\n</span><span class=\"token punctuation\">~~</span></span>~</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>リンク</h2>\n<ul>\n<li><a href=\"https://tamakiii.hatenablog.com/entry/2020/04/14/005648\">https://tamakiii.hatenablog.com/entry/2020/04/14/005648</a></li>\n</ul>","excerpt":"パターンルールと黒魔術 パターンルールは便利な反面、Makefile を複雑化しやすいです。 例えば、docker-compose のインターフェースとして、よく使うサブコマンドを、黒魔術の誘惑によってこのように書きたくなることもあります。\n といった規則の糖衣構文的なルールです。 しかしこういった黒魔術はメンテナン…","frontmatter":{"date":"December 13, 2020","slug":"/013-pattern-rule-and-black-magic","title":"パターンルールと黒魔術"}}},"pageContext":{"slug":"/013-pattern-rule-and-black-magic","nodes":[{"node":{"frontmatter":{"slug":"/001-makefile-in-2020","title":"2020年の Makefile"}}},{"node":{"frontmatter":{"slug":"/002-phony-target-and-prerequisites","title":"偽のターゲットと前提条件"}}},{"node":{"frontmatter":{"slug":"/003-variable","title":"変数"}}},{"node":{"frontmatter":{"slug":"/004-automatic-variable","title":"自動変数"}}},{"node":{"frontmatter":{"slug":"/005-c-and-f-option","title":"-C オプションと -f オプション"}}},{"node":{"frontmatter":{"slug":"/006-default-target","title":"デフォルトターゲット"}}},{"node":{"frontmatter":{"slug":"/007-exit-status","title":"終了ステータス"}}},{"node":{"frontmatter":{"slug":"/008-text-functions","title":"文字列の関数"}}},{"node":{"frontmatter":{"slug":"/009-functions-for-filenames","title":"ファイル名の関数"}}},{"node":{"frontmatter":{"slug":"/010-functions-for-lists","title":"リストの関数"}}},{"node":{"frontmatter":{"slug":"/011-shell-function","title":"shell 関数"}}},{"node":{"frontmatter":{"slug":"/012-pattern-rules","title":"パターンルール"}}},{"node":{"frontmatter":{"slug":"/013-pattern-rule-and-black-magic","title":"パターンルールと黒魔術"}}}]}},"staticQueryHashes":["3649515864","63159454"]}